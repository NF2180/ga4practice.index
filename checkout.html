<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout Page</title>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TBQZ253G');
  </script>
</head>
<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TBQZ253G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <h1>Checkout Page</h1>
  <div id="checkoutItem"></div>
  <button id="confirmPurchaseBtn">Confirm Purchase</button>

  <script src="assets/js/datalayer.js"></script>
  <script>
    // --- Utility functions ---
    function getLastItemForCheckout() {
      try { return JSON.parse(localStorage.getItem('lastCheckoutItem')); } catch(e){ return null; }
    }
    function storeLastItemForCheckout(item) { localStorage.setItem('lastCheckoutItem', JSON.stringify(item)); }
    function clearStoredItem() { localStorage.removeItem('lastCheckoutItem'); }

    // --- Retrieve last item ---
    const item = getLastItemForCheckout();
    if(item){
      document.getElementById('checkoutItem').innerHTML = `
        <p>Item: ${item.item_name}</p>
        <p>Price: ₹${item.price}</p>
      `;

      // Fire begin_checkout event
      pushEvent('begin_checkout', {
        ecommerce: {
          currency: 'INR',
          value: item.price,
          items: [item]
        }
      });
    }

    // --- Confirm Purchase ---
    const confirmBtn = document.getElementById('confirmPurchaseBtn');
    confirmBtn.addEventListener('click', function() {
      if(!item) {
        alert("No item in checkout!");
        return;
      }

      pushEvent('purchase', {
        ecommerce: {
          transaction_id: 'TXN-' + Date.now(),
          currency: 'INR',
          value: item.price,
          items: [item]
        }
      });

      clearStoredItem();

      console.log("✅ Purchase confirmed, redirecting to thank-you page...");
      setTimeout(()=>{ window.location.href = 'thank-you.html'; }, 500);
    });
  </script>
</body>
</html>
